trigger:
  branches:
    include:
      - "doc_test"

jobs:
- job: build_and_publish_docs
  pool: Ubuntu-1804-SGX-Azure
  steps:
    - checkout: self
      clean: true
      submodules: true

    - script: doxygen 
      displayName: Doxgen

    - script: |
        python3.7 -m venv env
        source env/bin/activate
        pip install -U -r requirements.txt
        make html
      displayName: Sphinx
      workingDirectory: sphinx

    - script: |
        git config --local user.name "Azure Pipelines"
        git config --local user.email "azuredevops@microsoft.com"
        git add .
        git commit -m "[ci skip] commit generated documentation"
      displayName: 'Commit pages'
      workingDirectory: sphinx/build/html

    - task: DownloadSecureFile@1
      inputs:
        secureFile: ccf
      displayName: 'Get the deploy key'

    - script: |
        mkdir ~/.ssh && mv $DOWNLOADSECUREFILE_SECUREFILEPATH ~/.ssh/id_rsa
        chmod 700 ~/.ssh && chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts
        git remote set-url --push origin git@github.com:microsoft/CCF.git
        git push origin HEAD:test_pages
      displayName: 'Publish GitHub Pages'
      condition: |
        and(not(eq(variables['Build.Reason'], 'PullRequest')),
            eq(variables['Build.SourceBranch'], 'refs/heads/doc_test'))